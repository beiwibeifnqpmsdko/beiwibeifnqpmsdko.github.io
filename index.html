<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Happy Birthday Mom üíñ</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg1: #FFE5D9;
    --bg2: #FFD6BA;
    --accent: #5C3A21;
    --card: #fff7f3;
    --muted: #7a5a47;
    --glass: rgba(255,255,255,0.7);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "Segoe UI", Roboto, system-ui, Arial;
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    color:var(--accent);
    -webkit-font-smoothing:antialiased;
    min-height:100vh;
  }
  .page {
    max-width:1000px;
    margin:28px auto;
    padding:20px;
  }

  .photo-wall {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  margin-top: 20px;
}

.round-img {
  width: 250px;
  height: auto;
  border-radius: 20px; /* round edges */
  object-fit: cover;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}


  header {
    text-align:center;
    margin-bottom:18px;
  }
  .typing {
    display:inline-block;
    font-size:2rem;
    font-weight:700;
    border-right:2px solid var(--accent);
    white-space:nowrap;
    overflow:hidden;
    width:0;
    animation: typing 3s steps(30,end) forwards;
    background:linear-gradient(90deg, rgba(255,255,255,0.0), rgba(255,255,255,0.25));
    padding:8px 16px;
    border-radius:12px;
    box-shadow: 0 6px 20px rgba(92,58,33,0.07);
    color:var(--accent);
  }
  @keyframes typing { from { width:0 } to { width:22ch } }

  /* grid of cards */
  .grid {
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
    gap:18px;
    align-items:start;
  }

  .card {
    background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.96));
    border-radius:18px;
    padding:18px;
    box-shadow: 0 8px 30px rgba(92,58,33,0.08);
    position:relative;
    overflow:hidden;
  }
  .card h2 { margin:0 0 8px 0; font-size:1.1rem; color:var(--accent) }
  .card p { margin:0; color:var(--muted) }

  /* countdown */
  #countdown, .countdown {
    font-size:1.6rem;
    text-align:center;
    margin-top:6px;
    font-weight:600;
  }
  .small {
    font-size:0.9rem;
    color:var(--muted);
  }

  /* holiday specific styles */
  .halloween { border-left: 4px solid #FF6B35; }
  .christmas { border-left: 4px solid #2E7D32; }
  .easter { border-left: 4px solid #9C27B0; }
  .birthday { border-left: 4px solid #E91E63; }

  /* music section */
  .music-section {
    margin-top: 30px;
    background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.96));
    border-radius:18px;
    padding:25px;
    box-shadow: 0 8px 30px rgba(92,58,33,0.08);
  }
  .music-section h2 {
    text-align: center;
    margin: 0 0 20px 0;
    font-size: 1.3rem;
    color: var(--accent);
  }
  .music-content {
    display: flex;
    flex-wrap: wrap;
    gap: 25px;
    justify-content: center;
    align-items: flex-start;
  }
  .playlist-container {
    flex: 1;
    min-width: 300px;
    max-width: 400px;
  }
  .sotd-container {
    flex: 1;
    min-width: 300px;
    max-width: 500px;
  }

  /* spotify area */
  .spotify-embed {
    display:flex;
    gap:12px;
    flex-direction:column;
    align-items:center;
  }
  .trackbox {
    width:100%;
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:center;
    flex-direction:column;
  }
  .track-info {
    text-align:center;
  }
  .play-embed {
    border-radius:12px;
    overflow:hidden;
    box-shadow: 0 6px 18px rgba(92,58,33,0.06);
  }
  .muted {
    color:var(--muted);
    font-size:0.95rem;
  }

  /* timeline */
  .timeline-section {
    margin-top: 30px;
    background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.96));
    border-radius:18px;
    padding:25px;
    box-shadow: 0 8px 30px rgba(92,58,33,0.08);
  }
  .timeline-section h2 {
    text-align: center;
    margin: 0 0 20px 0;
    font-size: 1.3rem;
    color: var(--accent);
  }
  .timeline { padding-left:12px; border-left:3px dashed rgba(92,58,33,0.06); }
  .event { margin:14px 0; padding-left:10px; position:relative; }
  .event h3 { margin:0 0 6px 0; font-size:1rem; }
  .event::before {
    content:"";
    position:absolute;
    left:-21px;
    top:6px;
    width:14px; height:14px;
    background: #FFB788;
    border-radius:50%;
    box-shadow: 0 3px 10px rgba(0,0,0,0.06);
  }

  /* hearts */
  .heart {
    position:fixed;
    pointer-events:none;
    width:18px; height:18px;
    transform:rotate(45deg);
    z-index:0;
  }
  .heart:before, .heart:after {
    content:""; position:absolute; width:18px; height:18px; background:pink; border-radius:50%;
  }
  .heart:before { left:0; top:-9px }
  .heart:after { left:9px; top:0 }

  /* controls */
  .controls { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:8px }
  .btn {
    background:var(--accent);
    color:white;
    border:none;
    padding:8px 12px;
    border-radius:10px;
    font-weight:600;
    cursor:pointer;
    box-shadow: 0 6px 16px rgba(92,58,33,0.12);
  }
  .btn.secondary {
    background:transparent;
    color:var(--accent);
    border:1px solid rgba(92,58,33,0.08);
    box-shadow:none;
  }

  label{display:block; font-size:0.9rem; margin:8px 0 6px 0}
  textarea, input[type="text"]{
    width:100%; padding:8px; border-radius:10px; border:1px solid rgba(92,58,33,0.08);
    font-family:inherit; font-size:0.95rem; resize:vertical;
  }

  footer{ margin-top:22px; text-align:center; color:var(--muted); font-size:0.9rem }

  @media (max-width:420px){
    .typing { font-size:1.4rem; animation-duration:2.4s; }
    .music-content {
      flex-direction: column;
    }
  }
</style>
</head>
<body>
<div class="page">
  <header>
    <div class="typing">Happy Birthday Mom! ‚ù§Ô∏è </div>
    <div class="small" style="margin-top:10px">A page I made for you ‚Äî feel free to ask for changes anytime loser.</div>
  </header>

  <!-- COUNTDOWNS SECTION -->
  <div class="grid">
    <!-- CARD: Birthday Countdown -->
    <section class="card birthday" id="card-countdown" aria-label="birthday countdown">
      <h2>Mom's NEXT Birthday Countdown</h2>
      <div id="countdown" class="countdown" aria-live="polite">‚Äî</div>
      <p class="small" style="margin-top:8px">Countdown updates every second. Birthday is set to <strong>3 December</strong>.</p>
    </section>

    <!-- CARD: Halloween Countdown -->
    <section class="card halloween" id="card-halloween" aria-label="halloween countdown">
      <h2>Halloween Countdown</h2>
      <div id="halloween-countdown" class="countdown" aria-live="polite">‚Äî</div>
      <p class="small" style="margin-top:8px">Countdown to <strong>31 October</strong>.</p>
    </section>

    <!-- CARD: Christmas Countdown -->
    <section class="card christmas" id="card-christmas" aria-label="christmas countdown">
      <h2>Christmas Countdown</h2>
      <div id="christmas-countdown" class="countdown" aria-live="polite">‚Äî</div>
      <p class="small" style="margin-top:8px">Countdown to <strong>25 December</strong>.</p>
    </section>

    <!-- CARD: Easter Countdown -->
    <section class="card easter" id="card-easter" aria-label="easter countdown">
      <h2>Easter Countdown</h2>
      <div id="easter-countdown" class="countdown" aria-live="polite">‚Äî</div>
      <p class="small" style="margin-top:8px">Countdown to Easter Sunday.</p>
    </section>
  </div>

  <!-- MUSIC SECTION -->
  <section class="music-section" id="music-section" aria-label="music section">
    <h2>Music & Song of the Day</h2>
    <div class="music-content">
      <!-- playlist embed -->
      <div class="playlist-container">
        <div class="spotify-embed">
          <p class="muted">Playlist:</p>
          <iframe id="playlistIframe"
            src="https://open.spotify.com/embed/playlist/0F8yGT3rAJjinOwDGd6PVu"
            width="300" height="380" frameborder="0" allow="encrypted-media" style="border-radius:12px;">
          </iframe>
        </div>
      </div>

      <!-- song of the day -->
      <div class="sotd-container">
        <div class="trackbox">
          <div id="sotd-status" class="muted">Selecting today's song‚Ä¶</div>
          <div id="sotd" style="display:none; width:100%;">
            <div class="track-info">
              <div id="sotd-title" style="font-weight:700"></div>
              <div id="sotd-artist" class="muted" style="margin-top:6px"></div>
            </div>
            <div id="sotd-player" class="play-embed" style="margin-top:10px"></div>
            <div style="margin-top:8px; text-align:center;">
              <a id="sotd-open" target="_blank" rel="noopener" class="small">Open in Spotify</a>
            </div>
          </div>

          <!-- fallback / manual input -->
          <div id="sotd-fallback" style="margin-top:12px; display:none; width:100%;">
            <div class="muted">Automatic fetch couldn't get tracks (Spotify CORS/changes). Easy fallback:</div>
            <label for="manualTracks">Paste playlist track URLs (one per line) or track IDs:</label>
            <textarea id="manualTracks" rows="4" placeholder="https://open.spotify.com/track/XXXXXXXXX"></textarea>
            <div class="controls" style="justify-content:flex-end;">
              <button class="btn" id="saveManual">Save tracks</button>
              <button class="btn secondary" id="clearManual">Clear</button>
            </div>
            <div id="manualSavedMsg" class="muted" style="margin-top:8px;"></div>
          </div>
        </div>
        <div class="photo-wall">
          <img src="images/music.png" class="round-img">
        </div>
      </div>
    </div>
  </section>

  <!-- TIMELINE SECTION -->
  <section class="timeline-section" id="timeline-section" aria-label="timeline of memories">
    <h2>Love you lots!</h2>
    <div class="timeline">
      <div class="event">
        <h3> ‚ù§Ô∏è </h3>
        <p>Thank you for everything you do mom, even the all the things we dont notice. You‚Äôre always there for us, and it means a lot more than you think and we say. I hope you like this website, and we love you soooo much!</p>
      </div>
      <div class="event">
        <h3>Photo Family Wall:</h3>
        <p>SEND ME MORE STUFF TO ADD HERE OFTEN!.</p>
        <div class="photo-wall">
          <img src="images/1image.jpg" class="round-img">
          <img src="images/2image.jpg" class="round-img">
          <img src="images/3image.jpg" class="round-img">
          <img src="images/4image.png" class="round-img">
          <img src="images/5image.jpg" class="round-img">
          <img src="images/6image.jpg" class="round-img">
          <img src="images/7image.jpg" class="round-img">    
        </div>
      </div>
      <div class="event">
        <h3>More to come</h3>
        <p>I'll add more stuff here in the future ‚Äî or you can suggest stuff to include or add!</p>
      </div>
    </div>
  </section>

  <footer>
   HAPPY BIRTHDAY!
  </footer>
</div>

<!-- floating hearts -->
<script>
  // Generate floating hearts
  (function spawnHearts(){
    const N = 18;
    for(let i=0;i<N;i++){
      const h = document.createElement('div');
      h.className='heart';
      const size = 10 + Math.random()*18;
      h.style.width = size+'px';
      h.style.height = size+'px';
      h.style.left = (Math.random()*100)+'vw';
      h.style.top = (60 + Math.random()*35)+'vh';
      h.style.opacity = 0.7 - Math.random()*0.5;
      const dur = 8 + Math.random()*10;
      h.style.transition = `transform ${dur}s linear, opacity ${dur}s linear`;
      document.body.appendChild(h);
      // animate
      requestAnimationFrame(()=> {
        h.style.transform = `translateY(-120vh) rotate(45deg)`;
        h.style.opacity = 0;
      });
      // remove after animation
      setTimeout(()=> h.remove(), (dur+0.5)*1000);
      // spawn next little later
      setTimeout(()=> {
        if(i===N-1) spawnHearts(); // keep gentle looping
      }, 1200*i);
    }
  })();
</script>

<script>
/* ------------------------------
   BIRTHDAY COUNTDOWN
   Edit birthdayDateStr if you want to change the birthday.
   Format: "YYYY-MM-DD" or "MM-DD" (keeps  current year)
   ------------------------------ */
(function(){
  const birthdayDateStr = "12-03"; // month-day (3 Dec) ‚Äî change here if needed
  const countdownEl = document.getElementById('countdown');

  function computeNextBirthday() {
    const now = new Date();
    const parts = birthdayDateStr.split('-');
    let month, day, year;
    if (parts.length === 2) {
      month = parseInt(parts[0],10); day = parseInt(parts[1],10); year = now.getFullYear();
    } else {
      year = parseInt(parts[0],10); month = parseInt(parts[1],10); day = parseInt(parts[2],10);
    }
    // Note: JS months are 0-based
    let b = new Date(year, month-1, day, 0,0,0);
    if (now > b) b = new Date(year+1, month-1, day,0,0,0);
    return b;
  }

  function update() {
    const now = new Date();
    const target = computeNextBirthday();
    const diff = Math.max(0, target - now);
    const days = Math.floor(diff / (1000*60*60*24));
    const hours = Math.floor((diff / (1000*60*60)) % 24);
    const minutes = Math.floor((diff / (1000*60)) % 60);
    const seconds = Math.floor((diff / 1000) % 60);
    if (diff <= 1000*60*60*24 && days===0) {
      countdownEl.textContent = "üéâ HAPPY BIRTHDAY! üéâ";
    } else {
      countdownEl.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
    }
  }
  update();
  setInterval(update, 1000);
})();

/* ------------------------------
   ADDITIONAL COUNTDOWNS
   ------------------------------ */
(function(){
  // Function to calculate Easter Sunday for a given year
  function getEasterDate(year) {
    const a = year % 19;
    const b = Math.floor(year / 100);
    const c = year % 100;
    const d = Math.floor(b / 4);
    const e = b % 4;
    const f = Math.floor((b + 8) / 25);
    const g = Math.floor((b - f + 1) / 3);
    const h = (19 * a + b - d - g + 15) % 30;
    const i = Math.floor(c / 4);
    const k = c % 4;
    const l = (32 + 2 * e + 2 * i - h - k) % 7;
    const m = Math.floor((a + 11 * h + 22 * l) / 451);
    const month = Math.floor((h + l - 7 * m + 114) / 31) - 1; // 0-based month
    const day = ((h + l - 7 * m + 114) % 31) + 1;
    return new Date(year, month, day);
  }

  // Function to calculate the next occurrence of a given date
  function getNextDate(month, day, year = null) {
    const now = new Date();
    if (year === null) {
      year = now.getFullYear();
    }
    let date = new Date(year, month - 1, day, 0, 0, 0);
    if (now > date) {
      date = new Date(year + 1, month - 1, day, 0, 0, 0);
    }
    return date;
  }

  // Function to update a countdown element
  function updateCountdown(elementId, targetDate, celebrationMessage) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const now = new Date();
    const diff = Math.max(0, targetDate - now);
    const days = Math.floor(diff / (1000*60*60*24));
    const hours = Math.floor((diff / (1000*60*60)) % 24);
    const minutes = Math.floor((diff / (1000*60)) % 60);
    const seconds = Math.floor((diff / 1000) % 60);
    
    if (diff <= 1000*60*60*24 && days===0) {
      element.textContent = celebrationMessage;
    } else {
      element.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
    }
  }

  // Function to update all countdowns
  function updateAllCountdowns() {
    // Halloween Countdown (October 31)
    const halloweenDate = getNextDate(10, 31);
    updateCountdown('halloween-countdown', halloweenDate, "üéÉ HAPPY HALLOWEEN! üéÉ");
    
    // Christmas Countdown (December 25)
    const christmasDate = getNextDate(12, 25);
    updateCountdown('christmas-countdown', christmasDate, "üéÑ MERRY CHRISTMAS! üéÑ");
    
    // Easter Countdown (calculate dynamically)
    const now = new Date();
    let easterDate = getEasterDate(now.getFullYear());
    if (now > easterDate) {
      easterDate = getEasterDate(now.getFullYear() + 1);
    }
    updateCountdown('easter-countdown', easterDate, "üê∞ HAPPY EASTER! üê∞");
  }

  // Initial update and then update every second
  updateAllCountdowns();
  setInterval(updateAllCountdowns, 1000);
})();

/* ------------------------------
   SONG OF THE DAY (random per day)
   Strategy:
   1) Try to scrape the public playlist page HTML via a CORS-relay (AllOrigins). This often works without API keys.
   2) Parse track links (/track/{id}) from the HTML.
   3) If that fails, show a friendly fallback where you can paste track URLs or IDs once (stored in localStorage).
   4) Choose a "random" track for the day by seeding with the current date so it's stable across refreshes that day.
   ------------------------------ */

(function(){
  const playlistId = "0F8yGT3rAJjinOwDGd6PVu"; // confirmed playlist
  const playlistUrl = `https://open.spotify.com/playlist/${playlistId}`;
  const sotdStatus = document.getElementById('sotd-status');
  const sotdBox = document.getElementById('sotd');
  const sotdPlayer = document.getElementById('sotd-player');
  const sotdTitle = document.getElementById('sotd-title');
  const sotdArtist = document.getElementById('sotd-artist');
  const sotdOpen = document.getElementById('sotd-open');
  const fallbackEl = document.getElementById('sotd-fallback');
  const manualTextarea = document.getElementById('manualTracks');
  const saveManualBtn = document.getElementById('saveManual');
  const clearManualBtn = document.getElementById('clearManual');
  const manualSavedMsg = document.getElementById('manualSavedMsg');

  // util: extract track ids from a string (ids or full urls)
  function extractTrackIds(text) {
    if(!text) return [];
    const ids = new Set();
    // match full urls
    const urlRegex = /open\.spotify\.com\/track\/([A-Za-z0-9]+)|spotify:track:([A-Za-z0-9]+)/g;
    let m;
    while((m = urlRegex.exec(text)) !== null) {
      ids.add(m[1] || m[2]);
    }
    // also split by lines and try to accept bare ids
    text.split(/\s+/).forEach(tok=>{
      const clean = tok.trim();
      if(/^[A-Za-z0-9]{8,32}$/.test(clean)) ids.add(clean);
    });
    return Array.from(ids);
  }

  // Save manual list
  saveManualBtn.addEventListener('click', ()=>{
    const ids = extractTrackIds(manualTextarea.value);
    if(ids.length===0){
      manualSavedMsg.textContent = "No track URLs/IDs found ‚Äî paste lines like https://open.spotify.com/track/XXXXXXXX";
      return;
    }
    localStorage.setItem('manualTracks_'+playlistId, JSON.stringify(ids));
    manualSavedMsg.textContent = `Saved ${ids.length} tracks. The Song of the Day will use these.`;
    setTimeout(()=> manualSavedMsg.textContent = "", 3500);
    renderSongOfTheDay(ids);
  });

  // Clear manual
  clearManualBtn.addEventListener('click', ()=>{
    localStorage.removeItem('manualTracks_'+playlistId);
    manualTextarea.value = "";
    manualSavedMsg.textContent = "Cleared saved tracks.";
    setTimeout(()=> manualSavedMsg.textContent = "", 2500);
    // try to auto fetch again
    init();
  });

  // Seeded random: hash a string to number
  function hashStringToInt(s){
    let h=2166136261;
    for(let i=0;i<s.length;i++){
      h ^= s.charCodeAt(i);
      h += (h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24);
    }
    return Math.abs(h >>> 0);
  }
  function seededPick(list, seedStr){
    if(!list || list.length===0) return null;
    const h = hashStringToInt(seedStr);
    const idx = h % list.length;
    return {id: list[idx], index: idx};
  }

  // render the chosen track (id or null)
  function renderSongOfTheDay(trackIds){
    if(!trackIds || trackIds.length===0) {
      sotdStatus.textContent = "No tracks available yet.";
      fallbackEl.style.display = 'block';
      return;
    }
    fallbackEl.style.display = 'none';
    const today = new Date().toISOString().slice(0,10); // YYYY-MM-DD
    const seed = playlistId + '|' + today;
    const chosen = seededPick(trackIds, seed);
    if(!chosen) {
      sotdStatus.textContent = "Couldn't pick a track.";
      return;
    }
    const tid = chosen.id;
    sotdStatus.style.display = 'none';
    sotdBox.style.display = 'block';

    // Embed small track player
    const embedHtml = `<iframe src="https://open.spotify.com/embed/track/${tid}" width="300" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media" style="border-radius:8px;"></iframe>`;
    sotdPlayer.innerHTML = embedHtml;
    sotdOpen.href = `https://open.spotify.com/track/${tid}`;
    sotdOpen.textContent = "Open in Spotify";

    // We will try to fetch the track title shown on the public playlist page if we have scraped it, otherwise show ID
    // See if cached metadata exists
    const metaKey = 'sotd_meta_'+tid;
    const metaJSON = localStorage.getItem(metaKey);
    if(metaJSON){
      try {
        const meta = JSON.parse(metaJSON);
        sotdTitle.textContent = "SONG OF THE DAY IS: "
        return;
      } catch(e){}
    }
    // fallback: display tid while we optionally try to fetch metadata via AllOrigins for the track page
    sotdTitle.textContent = "SONG OF THE DAY IS: Song ID: ";
    sotdArtist.textContent = "";

    // attempt to fetch the track page to get title/artist (may be blocked by CORS)
    const prox = 'https://api.allorigins.win/raw?url=';
    fetch(prox + encodeURIComponent('https://open.spotify.com/track/' + tid))
    .then(r => r.text())
    .then(html=>{
      // try to extract <title>Artist ‚Äì Song Name - Spotify</title>
      const titleMatch = html.match(/<title[^>]*>([^<]+)/i);
      if(titleMatch && titleMatch[1]){
        // title often like "Artist ‚Äì Track Name - Spotify"
        const t = titleMatch[1].replace(/\s*-*\s*Spotify.*$/i,'').trim();
        // try to split by " ‚Äì " or " - "
        let artist = "", track = t;
        if(t.indexOf('‚Äì')!==-1){
          const parts = t.split('‚Äì').map(s=>s.trim());
          artist = parts[0];
          track = parts.slice(1).join(' ‚Äì ');
        } else if(t.indexOf('-')!==-1){
          const parts = t.split('-').map(s=>s.trim());
          artist = parts[0];
          track = parts.slice(1).join(' - ');
        }
        sotdTitle.textContent = "SONG OF THE DAY IS: " + (track || t);
        sotdArtist.textContent = artist || "";
        // cache metadata briefly
        try { localStorage.setItem(metaKey, JSON.stringify({title:track, artist:artist})); } catch(e){}
      }
    }).catch(()=>{/* ignore metadata fetch errors */});
  }

  // Try to scrape playlist page for /track/{id} links
  function scrapePlaylistTracksFromHtml(html){
    const ids = new Set();
    // find /track/ID occurrences
    const re = /\/track\/([A-Za-z0-9]{8,64})/g;
    let m;
    while((m = re.exec(html)) !== null){
      ids.add(m[1]);
    }
    return Array.from(ids);
  }

  // Try to fetch playlist HTML via AllOrigins (a free CORS proxy). This may fail sometimes.
  function tryAutoFetchTracks(){
    sotdStatus.textContent = "Trying to load playlist tracks automatically‚Ä¶";
    const proxy = 'https://api.allorigins.win/raw?url=';
    const target = playlistUrl;
    // a promise that times out if slow
    const controller = new AbortController();
    const timeout = setTimeout(()=> controller.abort(), 10000);
    return fetch(proxy + encodeURIComponent(target), {signal: controller.signal})
      .then(r=>{
        clearTimeout(timeout);
        if(!r.ok) throw new Error('fetch failed');
        return r.text();
      })
      .then(html=>{
        const tracks = scrapePlaylistTracksFromHtml(html);
        if(tracks.length>0) return tracks;
        // If no /track/ found, maybe the page is dynamically loaded - try to find URI-like strings
        const alt = Array.from(new Set((html.match(/spotify:track:[A-Za-z0-9]+/g) || []).map(s=>s.split(':').pop())));
        return alt;
      });
  }

  // Initialize: fallback to saved manual, else try auto fetch, else show fallback UI
  function init(){
    const savedManual = localStorage.getItem('manualTracks_'+playlistId);
    if(savedManual){
      try {
        const arr = JSON.parse(savedManual);
        if(Array.isArray(arr) && arr.length>0){
          renderSongOfTheDay(arr);
          return;
        }
      } catch(e){}
    }

    tryAutoFetchTracks()
    .then(tracks=>{
      if(tracks && tracks.length>0){
        // store a small cache in localStorage
        try { localStorage.setItem('autoTracks_'+playlistId, JSON.stringify(tracks.slice(0,800))); } catch(e){}
        renderSongOfTheDay(tracks);
      } else {
        // no tracks found
        sotdStatus.textContent = "Couldn't auto-load tracks from Spotify. You can paste them manually below.";
        fallbackEl.style.display = 'block';
      }
    })
    .catch(err=>{
      // network/CORS proxies blocked or slow
      const cached = localStorage.getItem('autoTracks_'+playlistId);
      if(cached){
        try {
          const arr = JSON.parse(cached);
          if(Array.isArray(arr) && arr.length>0){
            sotdStatus.textContent = "Using cached playlist tracks.";
            renderSongOfTheDay(arr);
            return;
          }
        } catch(e){}
      }
      sotdStatus.textContent = "Auto-load unavailable. Please paste playlist tracks below (one per line).";
      fallbackEl.style.display = 'block';
    });
  }

  // allow manual paste to prefill textarea from saved manual
  (function populateManual(){
    const saved = localStorage.getItem('manualTracks_'+playlistId);
    if(saved){
      try {
        const arr = JSON.parse(saved);
        manualTextarea.value = arr.map(id=>'https://open.spotify.com/track/'+id).join("\n");
        manualSavedMsg.textContent = `Using saved ${arr.length} tracks.`;
        setTimeout(()=> manualSavedMsg.textContent = "", 2400);
      } catch(e){}
    }
  })();

  // start
  init();

})();
</script>
</body>
</html>
